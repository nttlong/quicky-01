<%page cached="True"/>

<%
    from quicky import encryptor

%>
<%
    import json
    self.cols=[
            {"headerName": request.get_app_res("Code"), "field": "code"},
            {"headerName": request.get_app_res("Name"), "field": "name"},
            {"headerName": request.get_app_res("Description"), "field": "description"},
            {"headerName": request.get_app_res("Created on"), "field": "created_on"},
            {"headerName": request.get_app_res("Created by"), "field": "created_by"},
            {"headerName": request.get_app_res("Modified on"), "field": "modified_on"},
            {"headerName": request.get_app_res("Modified by"), "field": "modified_by"}

        ]


%>

<script>
    (function(s){
        s.columns=${json.dumps(self.cols)};

    });
</script>
${self.body()}
<div class="row">
	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
        <div class="btn-toolbar pull-right" role="toolbar">
            <div class="btn-group">

            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-default" ng-click="$root.$dialog($id).params({source:source}).url(url_export_dialog).done()">${get_app_res("Export")}</button>

            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-default" ng-click="$root.$dialog($id).params({source:source}).url(url_editor_dialog).done()">${get_app_res("New")}</button>
            </div>
        </div>
	</div>
</div>
<div class="row">
	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
		&nbsp;
	</div>
</div>
<div class="row">
<div ag-grid="gridOptions" class="ag-theme-balham" style="height: 100%;"></div>
</div>


<script>
    (function(s){
        s.url_editor_dialog='${get_app_url("dialogs/dialogs/"+model["path"].split('/')[1])}';
        s.url_export_dialog='${get_app_url("dialogs/exports/download_excel")}';
        s.source='${encryptor.get_key(model["path"].split('/')[1])}';
        s.doLoadData=function(params,cb){
            s.$ws.api('${get_api_key('api.categories/get_list')}')
            .data({
                source:s.source,
                params:params
            }).done()
            .then(function(res){

                cb(null,res);
            });
        };

        s.doAddNew=function(item,callback){
            s.$ws.api('${get_api_key('api.categories/add_new_item')}')
            .data({
                source:s.source,
                item:item
            }).done()
            .then(function(res){

                s.doLoadData();
            });
        };
        s.doUpdate=function(item){
            s.$ws.api('${get_api_key('api.categories/update_item')}')
            .data({
                source:s.source,
                item:item
            }).done()
            .then(function(res){
                debugger;
                s.doLoadData();
            });
        };



        var dataSource = {
            rowCount: null,
            getRows: function (params) {
                pageIndex=params.endRow/100 -1;
                s.doLoadData({
                    filter:params.filterModel,
                    sort:params.sortModel,
                    pageIndex:pageIndex
                },function(ex,res){
                        console.log(res);
                        params.successCallback(res.items, res.total_items);
                });

            }
        };

        s.gridOptions = {
            columnDefs: s.columns,
            enableServerSideFilter: true,
            floatingFilter:true,
            enableServerSideSorting: true,
            enableColResize: true,
            rowBuffer: 0,
            debug: true,
            rowSelection: 'multiple',
            rowDeselection: true,
            rowModelType: 'infinite',
            paginationPageSize: 20,
            cacheOverflowSize: 2,
            maxConcurrentDatasourceRequests: 2,
            infiniteInitialRowCount: 1,
            maxBlocksInCache: 2,
            onGridReady: function(params) {
                console.log(params);
                debugger;
                params.api.sizeColumnsToFit();
                params.api.setDatasource(dataSource);
            }
        };


    });
</script>